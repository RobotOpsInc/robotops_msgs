name: Version Check

on:
  pull_request:
    branches: [development, main]

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from package.xml
        id: pkg_version
        run: |
          VERSION=$(grep -oP '(?<=<version>)[^<]+' package.xml)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Package version: $VERSION"

      - name: Validate version format and minimum
        run: |
          VERSION="${{ steps.pkg_version.outputs.version }}"

          # Check semver format
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Version '$VERSION' is not valid semver (X.Y.Z)"
            exit 1
          fi

          # Check >= 0.1.0
          IFS='.' read -r major minor patch <<< "$VERSION"
          if [[ "$major" -eq 0 && "$minor" -eq 0 ]]; then
            echo "::error::Version must be >= 0.1.0, got $VERSION"
            exit 1
          fi

          echo "Version $VERSION is valid"

      - name: Check CHANGELOG.rst for version entry
        run: |
          VERSION="${{ steps.pkg_version.outputs.version }}"

          # Check if CHANGELOG.rst has an entry for this version
          # Format: "X.Y.Z (YYYY-MM-DD)" at the start of a line
          if ! grep -qE "^${VERSION} \([0-9]{4}-[0-9]{2}-[0-9]{2}\)" CHANGELOG.rst; then
            echo "::error::CHANGELOG.rst missing entry for version ${VERSION}"
            echo "Expected format: '${VERSION} (YYYY-MM-DD)'"
            echo ""
            echo "Add a changelog entry like:"
            echo ""
            echo "${VERSION} ($(date +%Y-%m-%d))"
            echo "-------------------"
            echo ""
            echo "* Your changes here"
            exit 1
          fi

          echo "CHANGELOG.rst has entry for version ${VERSION}"

      - name: Determine Cloudsmith repository
        id: repo
        run: |
          if [[ "${{ github.base_ref }}" == "main" ]]; then
            echo "repo=robotops" >> $GITHUB_OUTPUT
            echo "Target: production (robotops)"
          else
            echo "repo=robotops-development" >> $GITHUB_OUTPUT
            echo "Target: development (robotops-development)"
          fi

      - name: Check version against Cloudsmith
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
        run: |
          REPO="${{ steps.repo.outputs.repo }}"
          NEW_VERSION="${{ steps.pkg_version.outputs.version }}"

          # Query Cloudsmith for existing package versions
          RESPONSE=$(curl -s -H "X-Api-Key: $CLOUDSMITH_API_KEY" \
            "https://api.cloudsmith.io/v1/packages/robotops/$REPO/?query=name:ros-jazzy-robotops-msgs" \
            || echo "[]")

          # Extract latest version if package exists
          LATEST=$(echo "$RESPONSE" | jq -r '.[0].version // empty' 2>/dev/null || echo "")

          if [[ -z "$LATEST" ]]; then
            echo "No existing package found in $REPO. First publish allowed."
            exit 0
          fi

          echo "Latest published version: $LATEST"
          echo "New version: $NEW_VERSION"

          # Compare versions using sort -V
          HIGHER=$(printf '%s\n%s' "$LATEST" "$NEW_VERSION" | sort -V | tail -n1)

          if [[ "$HIGHER" == "$LATEST" ]] || [[ "$NEW_VERSION" == "$LATEST" ]]; then
            echo "::error::New version ($NEW_VERSION) must be greater than published version ($LATEST)"
            exit 1
          fi

          echo "Version check passed: $NEW_VERSION > $LATEST"
