# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

ROS2 message package (`robotops_msgs`) for distributed tracing in RobotOps. Defines custom message types used by `rmw_robotops` to emit trace events that the Robot Agent consumes. Part of a larger observability system (ROB-33 epic).

## Development (Container-based)

ROS2 Jazzy has no native macOS support. All development uses Docker:

```bash
# Enter development container (ROS2 Jazzy)
docker compose run --rm dev

# Inside container - build and verify
colcon build --packages-select robotops_msgs
source install/setup.bash
ros2 interface show robotops_msgs/msg/TraceEvent
python3 -c "from robotops_msgs.msg import TraceEvent, TraceContextChange; print('OK')"
```

Build artifacts are cached in Docker volumes (`build-cache`, `install-cache`) for fast rebuilds.

## Debian Packaging

```bash
# Inside container - build .deb package
cd /ws/src/robotops_msgs
dpkg-buildpackage -us -uc -b

# Regenerate debian/ after package.xml changes
bloom-generate rosdebian --os-name ubuntu --os-version noble --ros-distro jazzy
```

## CI/CD Workflows

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `ci.yml` | Push to `feature/**` | Build verification |
| `version-check.yml` | PR to `development`/`main` | Ensure version incremented |
| `cd.yml` | Push to `development`/`main` | Build .deb, publish to Cloudsmith |

**Cloudsmith repos:**
- `robotops` - production (from `main`)
- `robotops-development` - development (from `development`)

**Versioning:** Update `<version>` in `package.xml` before merging. Must be > current published version.

## Documentation

The `docs/` directory contains end-user documentation. **When making changes that affect installation, usage, or workflows, check and update the relevant docs:**

- `docs/INSTALLATION.md` - End-user installation guide (apt setup, install commands)

## Package Structure

```
robotops_msgs/
├── CMakeLists.txt
├── package.xml                 # Version source of truth
├── docker-compose.yml          # Local dev container
├── Dockerfile                  # CI + packaging tools
├── debian/                     # Generated by bloom
├── docs/                       # End-user documentation
│   └── INSTALLATION.md         # Installation guide
├── .github/workflows/
│   ├── ci.yml                  # Feature branch builds
│   ├── version-check.yml       # Pre-merge version validation
│   └── cd.yml                  # Deploy to Cloudsmith
├── msg/
│   ├── TraceEvent.msg          # Primary trace context propagation
│   └── TraceContextChange.msg  # Log correlation (context enter/exit)
└── README.md
```

## Message Definitions

### TraceEvent.msg
Primary message for trace span events. Published on `/robotops/trace_events` (Reliable QoS, depth=1000).

Key fields:
- `trace_id`, `span_id`, `parent_span_id` - Trace identification (UUIDs)
- `span_links[]` - Fan-in handling, format: `"trace_id:span_id"`
- `operation` - One of: `OP_PUBLISH`, `OP_SUBSCRIBE`, `OP_SERVICE_REQUEST`, `OP_SERVICE_RESPONSE`, `OP_ACTION_GOAL_SENT`, `OP_ACTION_GOAL_RECEIVED`, `OP_ACTION_FEEDBACK`, `OP_ACTION_RESULT`, `OP_ACTION_CANCEL`, `OP_ACTION_GOAL_REJECTED`
- `publisher_gid`, `sequence_number` - For pub/sub correlation

### TraceContextChange.msg
Emitted on context changes for log correlation. Published on `/robotops/trace_context` (Reliable QoS, depth=100).

Key fields:
- `node_name`, `node_namespace`, `thread_id` - Node/thread identification
- `trace_id`, `span_id` - Current context (empty = cleared)
- `change_type` - `CONTEXT_ENTERED` or `CONTEXT_EXITED`

## Architecture Context

This package is consumed by:
- **rmw_robotops** (ROB-55): LD_PRELOAD intercept layer that publishes these messages
- **Robot Agent** (ROB-56): Rust subscriber that buffers spans for tail-based sampling

The trace events flow: ROS2 nodes → rmw_robotops intercept → TraceEvent topic → Robot Agent → OTel export (on interesting events only).

## Target Distro

ROS2 Jazzy on Ubuntu Noble (24.04). Uses `builtin_interfaces/Time` for timestamp fields.
